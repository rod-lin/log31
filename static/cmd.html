<!DOCTYPE html>

<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<meta http-equiv="Pragma" content="no-cache">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">

		<link rel="stylesheet" href="/static/css/cmd.css" />
		<script src="/static/js/util.js"></script>
	</head>

	<body>
		<script>
			String.prototype.trim = function () {
				return this.replace(/(^\s*)|(\s*$)/g, "");
			};

			Array.prototype.choose = function () {
				return this[Math.floor(Math.random() * this.length + 0)];
			};

			Object.prototype.addClass = function (cls) {
				var allc = this.className.split(/\s+/g);

				if (allc.indexOf(cls) == -1) {
					allc.push(cls);
					this.className = allc.join(" ");

					return true;
				}

				return false;
			};

			Object.prototype.removeClass = function (cls) {
				var allc = this.className.split(/\s+/g);
				var i = allc.indexOf(cls);

				if (i == -1) return false;

				allc.splice(i, 1);

				this.className = allc.join(" ");

				return true;
			};

			Object.prototype.own = Object.prototype.hasOwnProperty;

			function cmd_effChangeTitle(msg, callback, timeout) {
				var e = document.getElementById("cmd-title");
				var orig = e.innerHTML;
				var i;
				var total = 0;

				timeout = timeout || 500;

				var delay = timeout / orig.length / 2;

				for (i = 0; i < orig.length; i++) {
					total += Math.random() * delay + delay;
					setTimeout(function () {
						e.innerHTML = e.innerHTML.substr(0, e.innerHTML.length - 1);
					}, total);
				}

				delay = timeout / msg.length / 2;
				// total += delay;

				setTimeout(function () {
					for (i = 1; i <= msg.length; i++) {
						total += Math.random() * delay + delay;
						setTimeout((function (i) {
							if (i == msg.length) return function () {
								e.innerHTML = msg.substr(0, i);
							}; else return function () {
								e.innerHTML = msg.substr(0, i);
							};
						})(i), total);
					}

					setTimeout(callback, total);
				}, total);
			}

			var cmd_effTitleLock = false;

			function cmd_quickMessage(msg, timeout, callback) {
				var e = document.getElementById("cmd-title");
				var orig = "log31"; // e.innerHTML;

				if (cmd_effTitleLock) return;
				cmd_effTitleLock = true;

				cmd_effChangeTitle(msg, function () {
					setTimeout(function() {
						cmd_effChangeTitle(orig, function () { cmd_effTitleLock = false; if (callback) callback(); });
					}, timeout || 2000);
				});

				return;
			}

			function cmd_longMessage(msg, callback) {
				if (cmd_effTitleLock) return;
				cmd_effTitleLock = true;

				cmd_effChangeTitle(msg, function () { cmd_effTitleLock = false; if (callback) callback(); });

				return;
			}

			function cmd_effExitTitle() {
				var e = document.getElementById("cmd-textbox");
				
				e.disabled = true;
				e.addClass("cmd-exit");

				document.getElementById("cmd-underline").addClass("cmd-exit");
				document.getElementById("cmd-mainbox").addClass("cmd-exit");
				
				return;
			}

			function cmd_effShowTitle() {
				document.getElementById("cmd-textbox").removeClass("cmd-exit");
				document.getElementById("cmd-mainbox").removeClass("cmd-exit");
				return;
			}

			function cmd_goto(url) {
				window.location.href = url;
				return;
			}

			function cmd_setFrameSrc(url) {
				document.getElementById("cmd-main-frame").src = url;
				return;
			}

			function cmd_setFrameOnload(handler) {
				var e = document.getElementById("cmd-main-frame");

				if (e.attachEvent) {
					var h = function () {
						e.detachEvent("onload", h);
						handler();
					}

					e.attachEvent("onload", h);
				} else {
					e.onload = handler;
				}

				return;
			}

			function cmd_showFrame() {
				var e = document.getElementById("cmd-main-frame");

				e.style.top = "0";

				return;
			}

			function cmd_hideFrame() {
				var e = document.getElementById("cmd-main-frame");

				e.style.top = "100%";

				return;
			}

			function cmd_getFrameMsg() {
				return document.getElementById("cmd-main-frame").contentWindow.log31msg;
			}

			var cmd_color_box = [ "#1ABC9C", "#2ECC71", "#3498DB", "#9B59B6", "#E67E22", "#E74C3C", "#313131" ];
			var cmd_default_font = "";

			var cmd_defaultHandler = function (argv) {
				// cmd_quickMessage("hello");
				cmd_longMessage("conneting...", function () {
					cmd_effExitTitle();

					setTimeout(cmd_updateMainBoxPos, 300);

					var end = false;
					var loaded = false;
					var cast = function () {
						setTimeout(function () {
							cmd_showFrame();
							var msg = cmd_getFrameMsg();

							if (!msg.suc) {
								setTimeout(function () {
									cmd_hideFrame();
									setTimeout(function () {
										cmd_effShowTitle();
										setTimeout(function () {
											cmd_updateMainBoxPos();
											setTimeout(function () {
												document.getElementById("cmd-textbox").removeAttribute("disabled");
												document.getElementById("cmd-underline").removeClass("cmd-exit");
											}, 300);
										}, 500);
										cmd_longMessage("log31");
									}, 300);
								}, 2500);
							}
						}, 300);
					};

					cmd_setFrameSrc(argv.join("/"));
					cmd_setFrameOnload(function () {
						if (end) cast();
						loaded = true;
					});

					setTimeout(function () {
						if (loaded) cast();
						end = true;
					}, 1000);
				});

				return;
			};

			var cmd_cmd_handler = {
				"log": cmd_defaultHandler,

				"goto": function (argv) {
					if (argv.length < 2) {
						cmd_quickMessage("too less arguments");
					} else {
						cmd_goto(argv[1]);
					}

					return;
				},

				"color": function (argv) {
					if (argv.length < 2) {
						cmd_quickMessage("too less arguments");
					} else {
						var e = document.getElementById("cmd-bg");
						var arg1 = argv[1];

						if (arg1 == "change") {
							e.style.background = cmd_color_box.choose();
						} else if (arg1.match(/(#[0-9A-Za-z]+)/g)) {
							e.style.background = arg1;
						}
					}

					return;
				},

				"hello": function () {
					document.getElementById("cmd-bg").style.background = cmd_color_box.choose();
					cmd_quickMessage([
						"how are you?", "it's a nice day, isn't it?",
						"hi buddy", "long time no see, huh?",
						"what's up"
					].choose());

					return;
				},

				"font": function (argv) {
					if (argv.length < 2) {
						cmd_quickMessage("too less arguments");
					} else {
						var e = document.body;

						if (argv[1] == "default") {
							e.style["font-family"] = cmd_default_font;
							cmd_updateMainBoxPos();
							setCookie("log31-font", cmd_default_font);
						} else {
							e.style["font-family"] = argv[1];
							cmd_updateMainBoxPos();
							setCookie("log31-font", argv[1]);
						}
					}

					return;
				}
			};

			var cmd_cmdHist = [];
			var cmd_curHist = -1;

			function cmd_parseCommand() {
				var e = document.getElementById("cmd-textbox");
				var orig = e.value;
				var argv = orig.trim().split(/\s+/g);

				e.value = "";

				if (argv[0] == "") return;
				cmd_cmdHist.push(orig);

				e.placeholder = "";
				e.blur();

				if (cmd_cmd_handler.own(argv[0])) {
					cmd_cmd_handler[argv[0]](argv);
					e.focus();
				} else {
					cmd_quickMessage(":( no such command...", null, function () {
						e.focus();
					});
				}

				return;
			}

			function cmd_keydown(e) {
				var c = e.keyCode;
				var prevdef = function () {
					e.preventDefault();
					e.returnValue = false;
				};

				var speck =
					(e.ctrlKey ? 4 : 0) | /* 0b100 */
					(e.altKey ? 2 : 0) | /* 0b10 */
					(e.shiftKey ? 1 : 0); /* 0b1 */

				var c = (speck << 8) | c;

				switch (c) {
					case 13: // enter
						cmd_curHist = -1;
						cmd_parseCommand();
						break;

					case 38: // up
						if (cmd_curHist == -1) {
							if (cmd_cmdHist.length) {
								cmd_curHist = cmd_cmdHist.length - 1;
								document.getElementById("cmd-textbox").value = cmd_cmdHist[cmd_curHist];
							}
						} else if (cmd_curHist) {
							cmd_curHist--;
							document.getElementById("cmd-textbox").value = cmd_cmdHist[cmd_curHist];
						}

						break;

					case 40: // down
						if (cmd_curHist != -1) {
							if (cmd_curHist + 1 < cmd_cmdHist.length) {
								cmd_curHist++;
								document.getElementById("cmd-textbox").value = cmd_cmdHist[cmd_curHist];
							} else {
								cmd_curHist = -1;
								document.getElementById("cmd-textbox").value = "";
							}
						}

						break;
				}
			}

			function cmd_updateMainBoxPos() {
				var e = document.getElementById("cmd-mainbox");
				var bg = document.getElementById("cmd-bg");

				e.style.top = ((bg.clientHeight - e.offsetHeight) / 2) + "px";

				return;
			}

			window.onload = function () {
				var e = document.getElementById("cmd-textbox");

				e.removeAttribute("disabled");
				e.focus();			

				document.getElementById("cmd-bg").style.opacity = "1";
				cmd_updateMainBoxPos();

				cmd_default_font = document.body.style["font-family"];

				var font = getCookie("log31-font");
				if (font) {
					document.body.style["font-family"] = font;
				}
			};

			window.onresize = cmd_updateMainBoxPos;
		</script>
		<div id="cmd-bg" style="opacity: 0;">
			<div id="cmd-mainbox" class="cmd-mainbox">
				<span id="cmd-title" class="cmd-title" style="font-weight: bold;">log31</span><br>
				<input
					id="cmd-textbox"
					class="cmd-textbox"
					spellcheck=false
					placeholder="something?"
					onkeydown="cmd_keydown(event)"
				><br>
				<div id="cmd-underline" class="cmd-underline"></div>
			</div>
		</div>
		<iframe id="cmd-main-frame" class="cmd-main-frame" style="top: 100%;"></iframe>
	</body>
</html>
